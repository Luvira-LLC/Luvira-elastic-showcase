import React, { useEffect, useRef } from "react";
import { Animated, Easing, Pressable, View } from "react-native";
import Svg, { Circle, G, Path } from "react-native-svg";

import ScreenLayout from "@/components/layouts/screen-layout";
import { Text } from "@/components/ui/text";
import { useStreamStore } from "@/store/stream-store";
import { useRouter } from "expo-router";
import { AlertCircle } from "lucide-react-native";

const CIRCLE_SIZE = 200;
const STROKE_WIDTH = 4;
const RADIUS = (CIRCLE_SIZE - STROKE_WIDTH) / 2;
const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
const PROGRESS = 0.7;
const STROKE_DASHOFFSET = CIRCUMFERENCE * (1 - PROGRESS);

const AnimatedSvg = Animated.createAnimatedComponent(Svg);

export default function GeneratingInsight() {
  const rotateAnim = useRef(new Animated.Value(0)).current;
  const router = useRouter();
  const streamingMessage = useStreamStore((s) => s.streamingMessage);
  const uploadProgress = useStreamStore((s) => s.uploadProgress);
  const errorResponse = useStreamStore((s) => s.errorResponse);
  const resetStreamState = useStreamStore((s) => s.resetStreamState);

  const subtitle = streamingMessage
    || (uploadProgress > 0 && uploadProgress < 100
      ? `Sending audio... ${Math.round(uploadProgress)}%`
      : "Preparing...");

  useEffect(() => {
    Animated.loop(
      Animated.timing(rotateAnim, {
        toValue: 1,
        duration: 2000,
        easing: Easing.linear,
        useNativeDriver: true,
      }),
    ).start();
  }, [rotateAnim]);

  const rotation = rotateAnim.interpolate({
    inputRange: [0, 1],
    outputRange: ["0deg", "360deg"],
  });

  const handleRetry = () => {
    resetStreamState();
    router.replace("/(root)/recording");
  };

  if (errorResponse) {
    return (
      <ScreenLayout edges={["top", "left", "right", "bottom"]} showBackButton>
        <View className="flex-1 justify-center items-center px-6">
          <View className="size-20 rounded-full bg-destructive/15 items-center justify-center mb-6">
            <AlertCircle size={40} color="#ef4444" />
          </View>

          <Text
            className="text-xl font-bold text-foreground mb-2 text-center"
            style={{ fontFamily: "Urbanist_700Bold" }}
          >
            Something went wrong
          </Text>

          <Text
            className="text-sm text-muted-foreground text-center leading-5 mb-8 px-4"
            style={{ fontFamily: "Urbanist_400Regular" }}
          >
            {errorResponse}
          </Text>

          <Pressable
            onPress={handleRetry}
            className="rounded-full bg-primary px-8 py-3 active:bg-primary/90"
            accessibilityRole="button"
            accessibilityLabel="Try again"
          >
            <Text
              className="text-primary-foreground text-base font-semibold"
              style={{ fontFamily: "Urbanist_600SemiBold" }}
            >
              Try Again
            </Text>
          </Pressable>
        </View>
      </ScreenLayout>
    );
  }

  return (
    <ScreenLayout edges={["top", "left", "right", "bottom"]} showBackButton>
      <View className="flex-1 justify-center items-center px-6">
        {/* Circular Progress with Logo */}
        <View
          className="items-center justify-center mb-8"
          style={{ width: CIRCLE_SIZE, height: CIRCLE_SIZE }}
          accessibilityLabel="Generating insight progress indicator"
          accessibilityRole="progressbar"
          accessibilityValue={{ min: 0, max: 100, now: 70 }}
        >
          {/* Green filled circle */}
          <View
            className="rounded-full items-center border-8 border-primary justify-center absolute"
            style={{
              width: CIRCLE_SIZE - STROKE_WIDTH * 2,
              height: CIRCLE_SIZE - STROKE_WIDTH * 2,
            }}
          >
            {/* Luvira Logo SVG */}
            <Svg
              width={50}
              height={54}
              viewBox="0 0 38 41"
              fill="#3bcaca"
              accessibilityLabel="Luvira logo"
            >
              <Path
                d="M0.0695852 15.1324C0.880421 21.1593 3.46321 26.3965 8.21028 30.6127C12.7162 34.6128 18.1201 36.955 24.4342 37.4005C25.3867 37.4672 26.3331 37.5416 27.2914 37.5087C28.2439 37.4753 28.8829 38.0485 28.9161 38.8262C28.949 39.6264 28.4006 40.1607 27.382 40.2159C26.0891 40.2878 24.8112 40.0915 23.5512 39.8757C14.2079 38.2671 7.28819 33.5998 2.77924 25.9259C0.988876 22.8808 -0.32217 17.6321 0.0695852 15.1324Z"
                fill="#3bcaca"
              />
              <Path
                d="M2.96298 19.4565C3.98461 20.8409 4.92788 22.2802 6.11234 23.5648C10.2569 28.0578 15.4436 30.7733 21.8573 31.5097C25.7093 31.9525 29.401 31.4793 33.0088 30.2335C34.1511 29.8404 34.8806 30.0813 35.185 30.9116C35.4714 31.6951 34.9829 32.3153 33.8135 32.6058C23.518 35.1721 14.63 32.963 7.23966 25.893C5.32577 24.0602 3.88533 21.8985 2.9599 19.4565H2.96298Z"
                fill="#3bcaca"
              />
              <Path
                d="M6.13049 21.4222C7.84557 22.6126 9.5456 23.7502 11.3901 24.7275C18.5694 28.5394 28.509 27.8309 34.9469 23.0027C35.3175 22.7261 35.6822 22.4408 36.077 22.1943C36.6227 21.8539 37.2135 21.8095 37.6744 22.2886C38.166 22.7952 38.0693 23.3543 37.5961 23.8444C36.674 24.7994 35.4533 25.3947 34.2538 25.9649C25.2362 30.2558 14.5606 29.1483 7.02889 22.3717C6.70321 22.0781 6.42912 21.7404 6.13049 21.4222Z"
                fill="#3bcaca"
              />
              <Path
                d="M10.2898 22.4823C11.3898 22.8256 12.4719 23.2436 13.5962 23.4981C22.1919 25.4636 30.5074 22.3134 35.1608 15.365C35.2573 15.2211 35.3596 15.0825 35.4592 14.9386C35.8297 14.396 36.3333 14.0335 37.0145 14.4016C37.7378 14.792 37.6505 15.4149 37.2858 15.9962C35.7639 18.4128 33.6387 20.3119 31.1011 21.7984C27.171 24.099 22.8488 25.1259 18.1862 24.8159C15.3681 24.6279 12.7159 23.9108 10.2929 22.4823H10.2898Z"
                fill="#3bcaca"
              />
              <Path
                d="M13.8041 22.2526C18.9006 22.4712 23.3945 21.2477 27.1528 18.1003C29.8354 15.8521 31.6043 13.0978 32.4182 9.8394C32.5178 9.44346 32.5811 9.04221 32.6865 8.64906C32.8192 8.14522 33.0997 7.74928 33.7474 7.84381C34.3985 7.93777 34.7029 8.35296 34.6274 8.93432C34.4799 10.0862 34.0248 11.1655 33.5305 12.2175C30.3295 19.0249 23.1926 23.0305 15.1183 22.585C14.6813 22.5599 14.2503 22.5267 13.7983 22.2554L13.8041 22.2526Z"
                fill="#3bcaca"
              />
              <Path
                d="M17.2039 21.115C19.3378 20.3287 21.342 19.3709 23.0691 17.9645C27.3006 14.5123 28.9702 10.1801 28.3102 5.0558C28.2771 4.78757 28.1806 4.52435 28.1717 4.25611C28.1535 3.72717 28.3677 3.29833 29.0006 3.23727C29.6394 3.17649 29.9077 3.55821 29.998 4.09272C31.1766 11.1599 26.3122 19.2078 17.5235 21.1122C17.4208 21.1345 17.3093 21.1122 17.2039 21.1122V21.115Z"
                fill="#3bcaca"
              />
              <Path
                d="M19.6601 18.9058C20.6126 17.9121 21.4022 17.1397 22.1255 16.3202C25.3535 12.6578 25.878 6.64792 23.3462 2.5812C23.2378 2.40665 23.1262 2.22959 23.0208 2.05225C22.7554 1.60389 22.5928 1.13045 23.1865 0.820393C23.8253 0.488307 24.2262 0.867503 24.5095 1.35183C25.6276 3.26766 26.1281 5.33574 26.134 7.48663C26.1462 11.6058 24.5697 15.1271 21.2366 17.9397C20.8418 18.2745 20.4556 18.6233 19.657 18.9058H19.6601Z"
                fill="#3bcaca"
              />
              <Path
                d="M20.6369 16.719C21.4112 15.0964 22.0804 13.5133 22.3034 11.7773C22.7766 8.126 21.562 5.00617 18.8766 2.32941C18.6296 2.08014 18.3491 1.85876 18.0959 1.61506C17.698 1.23585 17.0531 0.837114 17.6138 0.272485C18.2646 -0.3836 18.7408 0.305945 19.1538 0.662846C20.3173 1.66496 21.2695 2.84163 21.8966 4.17861C23.7832 8.21188 23.6326 12.1816 21.2366 16.0269C21.0799 16.2815 20.8387 16.492 20.6369 16.7217V16.719Z"
                fill="#3bcaca"
              />
              <Path
                d="M20.5342 14.6704C20.8808 12.2451 20.8175 10.075 19.823 8.00415C18.5783 5.4102 16.4745 3.61092 13.6656 2.48138C13.4966 2.41502 13.3221 2.36539 13.1531 2.29596C12.7401 2.13006 12.4449 1.8752 12.6498 1.43493C12.8277 1.05321 13.2164 1.04207 13.5961 1.14997C14.7023 1.46533 15.6637 2.03302 16.5409 2.70583C20.3474 5.61542 21.8121 9.32468 20.953 13.8038C20.9232 13.97 20.8566 14.1275 20.7963 14.2881C20.7754 14.3492 20.7211 14.3988 20.5315 14.6729L20.5342 14.6704Z"
                fill="#3bcaca"
              />
              <Path
                d="M20.0159 12.4113C19.3525 10.4874 18.5481 8.71851 16.9897 7.26246C15.0519 5.44896 12.6857 4.61024 10.0006 4.37519C9.74437 4.35288 9.48199 4.34731 9.23495 4.29183C9.00575 4.2422 8.86131 4.07601 8.84598 3.85155C8.82813 3.57217 9.00295 3.3979 9.28011 3.3452C9.5305 3.30086 9.7926 3.2925 10.0488 3.29808C14.8651 3.43359 19.6392 7.6057 20.0371 12.0182C20.0491 12.1484 20.022 12.2786 20.0128 12.4113H20.0159Z"
                fill="#3bcaca"
              />
              <Path
                d="M18.7651 11.2846C17.0712 8.52442 14.5093 7.02684 11.1246 6.69754C9.86209 6.5729 8.64108 6.80544 7.43571 7.14617C7.05594 7.25408 6.59476 7.42277 6.43192 6.89411C6.30227 6.46778 6.68203 6.31275 7.03782 6.18253C11.2994 4.63782 17.4359 7.27331 18.7651 11.2846Z"
                fill="#3bcaca"
              />
              <Path
                d="M16.8724 10.1166C15.8928 9.5628 14.9766 9.03136 13.9157 8.74333C11.2963 8.03203 8.91542 8.45835 6.70013 9.87007C6.48905 10.0059 6.29025 10.1581 6.07025 10.2744C5.82628 10.4015 5.56389 10.4155 5.39213 10.1692C5.25941 9.98104 5.30487 9.77611 5.45851 9.60993C5.55191 9.5076 5.66651 9.42172 5.78111 9.33863C8.48435 7.3121 13.7018 7.34555 16.3869 9.41614C16.5919 9.57395 16.8844 9.70137 16.8724 10.1221V10.1166Z"
                fill="#3bcaca"
              />
              <Path
                d="M14.7775 9.69832C14.5305 9.87008 14.2773 9.76217 14.03 9.72871C11.0223 9.32217 8.65027 10.2883 6.79689 12.478C6.51332 12.8126 6.29638 13.668 5.65424 13.2004C5.13311 12.8184 5.7719 12.2923 6.11542 11.9326C8.2493 9.69274 10.8865 8.75727 14.1083 9.40499C14.3465 9.45211 14.63 9.44374 14.7745 9.69859L14.7775 9.69832Z"
                fill="#3bcaca"
              />
              <Path
                d="M13.5178 10.2272C11.5228 10.551 9.8409 11.3289 8.61406 12.8485C8.05668 13.5409 7.67663 14.2909 7.47783 15.1271C7.4084 15.4204 7.35124 15.8328 6.93243 15.7609C6.41381 15.6694 6.59783 15.2403 6.67897 14.9278C7.34509 12.4361 10.311 9.93922 13.5148 10.23L13.5178 10.2272Z"
                fill="#3bcaca"
              />
              <Path
                d="M12.5051 10.9054C12.3303 11.318 11.9898 11.4092 11.7367 11.5754C9.90112 12.7796 8.9637 14.3907 9.03313 16.478C9.03898 16.6467 9.06017 16.8129 9.0571 16.9819C9.05432 17.2392 9.14773 17.5853 8.69853 17.5744C8.36701 17.566 8.35195 17.2696 8.33076 17.0402C8.23122 15.9826 8.35808 14.947 8.86137 13.9864C9.6117 12.558 10.7209 11.4619 12.5051 10.9081V10.9054Z"
                fill="#3bcaca"
              />
            </Svg>
          </View>

          {/* Animated progress arc */}
          <AnimatedSvg
            width={CIRCLE_SIZE}
            height={CIRCLE_SIZE}
            style={{
              position: "absolute",
              transform: [{ rotate: rotation }],
            }}
          >
            <G
              transform={`rotate(-90, ${CIRCLE_SIZE / 2}, ${CIRCLE_SIZE / 2})`}
            >
              {/* Progress arc */}
              <Circle
                cx={CIRCLE_SIZE / 2}
                cy={CIRCLE_SIZE / 2}
                r={RADIUS}
                stroke="#000"
                strokeWidth={STROKE_WIDTH}
                fill="none"
                strokeDasharray={CIRCUMFERENCE}
                strokeDashoffset={STROKE_DASHOFFSET}
                strokeLinecap="round"
              />
            </G>
          </AnimatedSvg>
        </View>

        {/* Title */}
        <Text
          className="text-xl font-bold text-foreground mb-2 text-center"
          style={{ fontFamily: "Urbanist_700Bold" }}
        >
          Generating Insight Card...
        </Text>

        {/* Subtitle */}
        <Text
          className="text-base text-muted-foreground text-center"
          style={{ fontFamily: "Urbanist_400Regular" }}
        >
          {subtitle}
        </Text>
      </View>
    </ScreenLayout>
  );
}
